<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Municipio X - Biblioteca Elsa Morante</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="icon" href="favicon.png" type="image/png">
    <style>
body,html{margin:0;padding:0;height:100%;width:100%}
#map{height:100vh;width:100%}
.search-box{position:absolute;top:10px;left:50px;z-index:1000;background:#fff;padding:10px;border-radius:5px;box-shadow:0 0 15px rgba(0,0,0,.2);display:flex;align-items:center}
.search-box input{width:250px;margin-right:10px;padding:5px 10px;border:1px solid #ccc;border-radius:3px;font-size:14px}
.search-box button{background-color:#4285f4;color:#fff;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;font-size:14px}
.search-box .icon{width:24px;height:24px;margin-right:10px;cursor:pointer}
.search-box .separator{width:1px;height:24px;background-color:#ccc;margin:0 10px}
.legend {
    background: rgba(255, 255, 255, 0.95);
    padding: 18px 22px;
    font: 13px/15px 'Segoe UI', system-ui, sans-serif;
    box-shadow: 0 5px 25px rgba(0,0,0,0.15);
    border-radius: 12px;
    position: absolute;
    bottom: 25px;
    right: 15px;
    z-index: 1000;
    max-height: 65vh;
    overflow-y: auto;
    width: 300px;
    border: 1px solid rgba(0,0,0,0.1);
    backdrop-filter: blur(4px);
    transition: all 0.3s ease;
}

.legend-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px 20px;
}

.legend-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    background: rgba(255,255,255,0.7);
    border: 1px solid transparent;
}

.legend-item:hover {
    background: rgba(241, 242, 246,0.6);
    transform: translateX(3px);
    border-color: #dfe4ea;
}

.legend-item.highlighted {
    background: #f8f9fa;
    box-shadow: 0 3px 15px rgba(0,0,0,0.1);
    border-color: #ced6e0;
}

.legend-item span {
    width: 20px;
    height: 20px;
    margin-right: 12px;
    border-radius: 5px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
}

.legend-item:hover span {
    transform: scale(1.1);
}

.legend-item .text {
    font-size: 13px;
    color: #4a5568;
    font-weight: 500;
    letter-spacing: 0.03em;
}

.municipio-highlight {
    stroke-width: 4px !important;
    stroke-opacity: 0.9 !important;
    filter: drop-shadow(0 0 12px rgba(0,0,0,0.15));
    animation: pulseBorder 1.5s ease-in-out infinite;
}

.municipio-selected {
    stroke-width: 5px !important;
    stroke-opacity: 1 !important;
    fill-opacity: 0.2 !important;
    filter: drop-shadow(0 0 15px rgba(0, 0, 0, 0.3));
}

@keyframes pulseBorder {
    0% { stroke-width: 4px; }
    50% { stroke-width: 5px; }
    100% { stroke-width: 4px; }
}
.leaflet-routing-container{position:relative}
.routing-close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 24px;
    height: 24px;
    background-color: rgba(255, 77, 77, 0.7);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    z-index: 1000;
    transition: background-color 0.3s;
}

.routing-close-btn:hover {
    background-color: rgba(255, 26, 26, 0.8);
}
.custom-popup .leaflet-popup-content-wrapper {
    background-color: rgb(255, 255, 255);  /* Fully opaque white background */
    border-radius: 8px;
}

.custom-popup .leaflet-popup-tip {
    background-color: rgb(255, 255, 255);  /* Fully opaque white background */
}

.custom-popup {
    margin-bottom: 30px;
}

.custom-popup .leaflet-popup-close-button {
    color: #ff4d4d;
    font-size: 20px;
    font-weight: bold;
    opacity: 1;
    right: 8px;
    top: 8px;
}

.custom-popup .leaflet-popup-close-button:hover {
    color: #ff1a1a;
}
        .hours-info {
            margin-top: 10px;
            font-size: 12px;
            color: #333;
        }

        .baloon h3 {
    margin: 0 0 10px 0;
    color: #333;
}

.baloon p {
    margin: 0 0 10px 0;
    line-height: 1.4;
}

.baloon a {
    display: inline-block;
    text-decoration: none;
    margin-top: 5px;
}

    </style>
</head>
<body>
  <div class="search-box">
        
        <a href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Elsa%20Morante/RMBO2" title="Vai alla Biblioteca Morante">
            <img src="home.svg" alt="Biblioteca Home" class="icon">
        </a>
        <input type="text" id="start-point" placeholder="Inserisci punto di partenza">
        <button onclick="searchRoute()" title="Trova percorso fino alla Biblioteca Morante">Trova Percorso</button>
    </div>
    <div id="map"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    
    <script>

// Prima di tutto, aggiungiamo una variabile per tenere traccia del confine attualmente visualizzato
let currentBorder = null;

// Funzione helper per caricare e visualizzare il confine di un municipio
async function loadAndShowBorder(municipalityNumber, map) {
    // Se c'è già un confine visualizzato, rimuovilo
    if (currentBorder) {
        map.removeLayer(currentBorder);
    }

    try {
        const response = await fetch(`municipio${municipalityNumber}.geojson`);
        const data = await response.json();
        
        // Colori per i diversi municipi
        const municipalityColors = {
            1: '#6a3f3a',  // marrone
            2: '#00faff',  // ciano
            3: '#fbd51c',  // oro
            4: '#473e86',  // viola
            5: '#018a87',  // verde acqua scuro
            6: '#d33682',  // magenta
            7: '#ff7c4e',  // arancione
            8: '#22a825',  // verde
            9: '#2b83cb',  // blue
            10: '#287fc7', // blu
            11: '#cac12e', // giallo
            12: '#a329ca', // viola
            13: '#c9832c', // arancione
            14: '#7b7b79', // grigio
            15: '#000000'  // nero
        };

        currentBorder = L.geoJSON(data, {
            style: {
                color: municipalityColors[municipalityNumber],
                weight: 3,
                opacity: 0.65,
                fillOpacity: 0.2  
            }
        }).addTo(map);

        map.fitBounds(currentBorder.getBounds());
    } catch (error) {
        console.error(`Errore nel caricamento del confine del municipio ${municipalityNumber}:`, error);
    }
}
        



        
document.addEventListener("DOMContentLoaded", function() {
    const center = [41.732522, 12.271879];
    const map = L.map("map").setView(center, 14);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    // Definizione del percorso
    const pathPoints = [
        center,
        [41.732154, 12.271675],
        [41.732282, 12.271254],
        [41.73224, 12.27123],
        [41.732276, 12.27109],
        [41.732092, 12.27098]
    ];

    // Creazione della linea tratteggiata
    const dottedLine = L.polyline(pathPoints, {
        color: "#0000FF",
        weight: 4,
        opacity: 0.8,
        dashArray: "10, 10"
    }).addTo(map);

    // Punto finale del percorso
    const endPoint = pathPoints[pathPoints.length - 1];

    // Definizione della funzione createMarker
    function createMarker(coords, title, icon, popupContent, municipioNumber, map) {
        const marker = L.marker(coords, { title, icon })
            .addTo(map)
            .on('click', () => loadAndShowBorder(municipioNumber, map));

        const popup = L.popup({
            className: 'custom-popup',
            offset: [0, -10],
            closeButton: true
        }).setContent(popupContent);

        marker.bindPopup(popup);
        return marker;
    }

const icons = {
    municipio1: L.icon({
        iconUrl: 'marker-brown.png', // Marrone
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    }),
    municipio2: L.icon({
        iconUrl: 'marker-ciano.png', // Ciano
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    }),
    municipio3: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png', // Oro
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    }),
    municipio4: L.icon({
        iconUrl: 'marker-violet.png', // Viola
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    }),
    municipio5: L.icon({
        iconUrl: 'marker-darkcyan.png', // Verde acqua scuro
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    }),
    municipio6: L.icon({
        iconUrl: 'marker-magenta.png', // Magenta
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    }),
    municipio7: L.icon({
        iconUrl: 'marker-arancio.png', // Arancione
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    }),
    municipio8: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', // Verde
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    }),
    municipio9: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', // Blu
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    }),
    municipio10: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', // Rosso
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    }),
    municipio11: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png', // Giallo
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    }),
    municipio12: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png', // Viola
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    }),
    municipio13: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png', // Arancione
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    }),
    municipio14: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png', // Grigio
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    }),
    municipio15: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png', // Nero
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    })
};

// Qui inizierai a creare i marker per le biblioteche...
createMarker(
    [41.876553, 12.478932], // Coordinate
    "Biblioteca Enzo Tortora", // Titolo
    icons.municipio1, // Icona per Municipio 1 (marrone)
    `
    <div class="baloon">
        <h3>Biblioteca Enzo Tortora</h3>
        <p style="font-size: 15px;">
            Via N. Zabaglia, 27b
            <br>00153 Municipio ROMA I
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Enzo%20Tortora/RMBA3">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    1, // Municipio
    map // Mappa
);

    
createMarker(
    [41.893223, 12.473114], // Coordinate
    "Biblioteca Centrale Ragazzi", // Titolo
    icons.municipio1, // Icona per Municipio 1 (marrone)
    `
    <div class="baloon">
        <h3>Biblioteca Centrale Ragazzi</h3>
        <p style="font-size: 15px;">
            Via San Paolo alla Regola, 15/18
            <br>00186 Municipio ROMA I
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Centrale%20Ragazzi/RMBBR">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    1, // Municipio
    map // Mappa
);

    
createMarker(
    [41.894238, 12.463663], // Coordinate
    "Biblioteca Casa della Memoria e della Storia", // Titolo
    icons.municipio1, // Icona per Municipio 1 (marrone)
    `
    <div class="baloon">
        <h3>Biblioteca Casa della Memoria e della Storia</h3>
        <p style="font-size: 15px;">
            Via di San Francesco di Sales, 5
            <br>00165 Municipio ROMA I
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Casa%20della%20Memoria%20e%20della%20Storia/RMBA5">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    1, // Municipio
    map // Mappa
);

createMarker(
    [41.899150, 12.468542], // Coordinate
    "Biblioteca Casa delle Letterature", // Titolo
    icons.municipio1, // Icona per Municipio 1 (marrone)
    `
    <div class="baloon">
        <h3>Biblioteca Casa delle Letterature</h3>
        <p style="font-size: 15px;">
            Piazza dell'Orologio, 3
            <br>00186 Municipio ROMA I
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Casa%20delle%20Letterature/RMBA7">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    1, // Municipio
    map // Mappa
);

    
createMarker(
    [41.911471, 12.452385], // Coordinate
    "Biblioteca Giordano Bruno", // Titolo
    icons.municipio1, // Icona per Municipio 1 (marrone)
    `
    <div class="baloon">
        <h3>Biblioteca Giordano Bruno</h3>
        <p style="font-size: 15px;">
            Via Giordano Bruno, 47
            <br>00195 Municipio ROMA I
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Giordano%20Bruno/RMBS1">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    1, // Municipio
    map // Mappa
);

    
createMarker(
    [41.903016, 12.486805], // Coordinate
    "Casa delle Traduzioni", // Titolo
    icons.municipio1, // Icona per Municipio 1 (marrone)
    `
    <div class="baloon">
        <h3>Casa delle Traduzioni</h3>
        <p style="font-size: 15px;">
            Via degli Avignonesi, 32
            <br>00187 Municipio ROMA I
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Casa%20delle%20Traduzioni/RMBA6">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    1, // Municipio
    map // Mappa
);

   createMarker(
    [41.912960, 12.498767], // Coordinate
    "Biblioteca Europea", // Titolo
    icons.municipio2, // Icona per Municipio 2 (ciano)
    `
    <div class="baloon">
        <h3>Biblioteca Europea</h3>
        <p style="font-size: 15px;">
            Via Savoia, 13
            <br>00198 Municipio ROMA II
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Europea/RMBA1">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    2, // Municipio
    map // Mappa
);

    createMarker(
    [41.923581, 12.470486], // Coordinate
    "Biblioteca Flaminia", // Titolo
    icons.municipio2, // Icona per Municipio 2 (ciano)
    `
    <div class="baloon">
        <h3>Biblioteca Flaminia</h3>
        <p style="font-size: 15px;">
            Via Cesare Fracassini, 9
            <br>00196 Municipio ROMA II
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Flaminia/RMBB3">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    2, // Municipio
    map // Mappa
);

    createMarker(
    [41.926791, 12.521807], // Coordinate
    "Biblioteca Villa Leopardi", // Titolo
    icons.municipio2, // Icona per Municipio 2 (ciano)
    `
    <div class="baloon">
        <h3>Biblioteca Villa Leopardi</h3>
        <p style="font-size: 15px;">
            Via Makallè (entrata parco)
            <br>00199 Municipio ROMA II
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Villa%20Leopardi/RMBB1">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    2, // Municipio
    map // Mappa
);

    createMarker(
    [41.899404, 12.514206], // Coordinate
    "Biblioteca Tullio De Mauro", // Titolo
    icons.municipio2, // Icona per Municipio 2 (ciano)
    `
    <div class="baloon">
        <h3>Biblioteca Tullio De Mauro</h3>
        <p style="font-size: 15px;">
            Via Tiburtina, 113
            <br>(entrata Parco Villa Mercede)
            <br>00185 Municipio ROMA II
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Tullio%20De%20Mauro/RMBC1">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    2, // Municipio
    map // Mappa
);

    createMarker(
    [41.952327, 12.530240], // Coordinate
    "Biblioteca Ennio Flaiano", // Titolo
    icons.municipio3, // Icona per Municipio 3 (oro)
    `
    <div class="baloon">
        <h3>Biblioteca Ennio Flaiano</h3>
        <p style="font-size: 15px;">
            Via Monte Ruggero, 39
            <br>00139 Municipio ROMA III
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Ennio%20Flaiano/RMBD1">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    3, // Municipio
    map // Mappa
);

    
createMarker(
    [41.944622, 12.585136], // Coordinate
    "Biblioteca Aldo Fabrizi", // Titolo
    icons.municipio4, // Icona per Municipio 4 (viola)
    `
    <div class="baloon">
        <h3>Biblioteca Aldo Fabrizi</h3>
        <p style="font-size: 15px;">
            Via Treia, 14
            <br>00156 Municipio ROMA IV
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Aldo%20Fabrizi/RMBE2">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    4, // Municipio
    map // Mappa
);

    createMarker(
    [41.934058, 12.560290], // Coordinate
    "Biblioteca Fabrizio Giovenale", // Titolo
    icons.municipio4, // Icona per Municipio 4 (viola)
    `
    <div class="baloon">
        <h3>Biblioteca Fabrizio Giovenale</h3>
        <p style="font-size: 15px;">
            Via Fermo Corni - Parco di Aguzzano
            <br>00156 Municipio ROMA IV
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Fabrizio%20Giovenale/RMBWA">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    4, // Municipio
    map // Mappa
);

    createMarker(
    [41.913727, 12.564600], // Coordinate
    "Biblioteca Vaccheria Nardi", // Titolo
    icons.municipio4, // Icona per Municipio 4 (viola)
    `
    <div class="baloon">
        <h3>Biblioteca Vaccheria Nardi</h3>
        <p style="font-size: 15px;">
            Via Grotta di Gregna, 37
            <br>00155 Municipio ROMA IV
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Vaccheria%20Nardi/RMBE1">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    4, // Municipio
    map // Mappa
);

    createMarker(
    [41.898611, 12.566118], // Coordinate
    "Biblioteca Penazzato", // Titolo
    icons.municipio5, // Icona per Municipio 5 (verde acqua scuro)
    `
    <div class="baloon">
        <h3>Biblioteca Penazzato</h3>
        <p style="font-size: 15px;">
            Via D. Penazzato, 112
            <br>00177 Municipio ROMA V
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Penazzato/RMBF2">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    5, // Municipio
    map // Mappa
);

    createMarker(
    [41.891476, 12.575938], // Coordinate
    "Teatro Biblioteca Quarticciolo", // Titolo
    icons.municipio5, // Icona per Municipio 5 (verde acqua scuro)
    `
    <div class="baloon">
        <h3>Teatro Biblioteca Quarticciolo</h3>
        <p style="font-size: 15px;">
            Via Castellaneta, 10
            <br>00171 Municipio ROMA V
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Teatro%20Biblioteca%20Quarticciolo/RMBG2">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    5, // Municipio
    map // Mappa
);

    createMarker(
    [41.881422, 12.589056], // Coordinate
    "Biblioteca Gianni Rodari", // Titolo
    icons.municipio5, // Icona per Municipio 5 (verde acqua scuro)
    `
    <div class="baloon">
        <h3>Biblioteca Gianni Rodari</h3>
        <p style="font-size: 15px;">
            Via F. Tovaglieri, 237/A
            <br>00155 Municipio ROMA V
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Gianni%20Rodari/RMBG1">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    5, // Municipio
    map // Mappa
);

  createMarker(
    [41.889446, 12.524513], // Coordinate
    "Biblioteca Goffredo Mameli", // Titolo
    icons.municipio5, // Icona per Municipio 5 (verde acqua scuro)
    `
    <div class="baloon">
        <h3>Biblioteca Goffredo Mameli</h3>
        <p style="font-size: 15px;">
            Via del Pigneto, 22
            <br>00176 Municipio ROMA V
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Goffredo%20Mameli/RMBF1">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    5, // Municipio
    map // Mappa
);

    createMarker(
    [41.869678, 12.670410], // Coordinate
    "Biblioteca Borghesiana", // Titolo
    icons.municipio6, // Icona per Municipio 6 (magenta)
    `
    <div class="baloon">
        <h3>Biblioteca Borghesiana</h3>
        <p style="font-size: 15px;">
            Largo Monreale snc
            <br>00133 Municipio ROMA VI
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Borghesiana/RMBH2">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    6, // Municipio
    map // Mappa
);

    createMarker(
    [41.863839, 12.685332], // Coordinate
    "Biblioteca Collina della Pace", // Titolo
    icons.municipio6, // Icona per Municipio 6 (magenta)
    `
    <div class="baloon">
        <h3>Biblioteca Collina della Pace</h3>
        <p style="font-size: 15px;">
            Via Bompietro, 16
            <br>00132 Municipio ROMA VI
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Collina%20della%20Pace/RMBH3">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    6, // Municipio
    map // Mappa
);

   createMarker(
    [41.870675, 12.577259], // Coordinate
    "Biblioteca Rugantino", // Titolo
    icons.municipio7, // Icona per Municipio 7 (arancione)
    `
    <div class="baloon">
        <h3>Biblioteca Rugantino</h3>
        <p style="font-size: 15px;">
            Via Rugantino, 113
            <br>00169 Municipio ROMA VII
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Rugantino/RMBH1">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    7, // Municipio
    map // Mappa
);

    
createMarker(
    [41.852229, 12.592527], // Coordinate
    "Biblioteca Casa dei Bimbi", // Titolo
    icons.municipio7, // Icona per Municipio 7 (arancione)
    `
    <div class="baloon">
        <h3>Biblioteca Casa dei Bimbi</h3>
        <p style="font-size: 15px;">
            Via Libero Leonardi, 153
            <br>00173 Municipio ROMA VII
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Casa%20dei%20Bimbi/RMBL3">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    7, // Municipio
    map // Mappa
);

    createMarker(
    [41.844170, 12.583459], // Coordinate
    "Biblioteca Raffaello", // Titolo
    icons.municipio7, // Icona per Municipio 7 (arancione)
    `
    <div class="baloon">
        <h3>Biblioteca Raffaello</h3>
        <p style="font-size: 15px;">
            Via Tuscolana, 1111
            <br>00173 Municipio ROMA VII
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Raffaello/RMBL1">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    7, // Municipio
    map // Mappa
);

    createMarker(
    [41.886103, 12.511739], // Coordinate
    "Biblioteca Nelson Mandela", // Titolo
    icons.municipio7, // Icona per Municipio 7 (arancione)
    `
    <div class="baloon">
        <h3>Biblioteca Nelson Mandela</h3>
        <p style="font-size: 15px;">
            Via La Spezia, 21
            <br>00182 Municipio ROMA VII
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Nelson%20Mandela/RMBI1">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    7, // Municipio
    map // Mappa
);

    createMarker(
    [41.840736, 12.484340], // Coordinate
    "Biblioteca Arcipelago Auditorium", // Titolo
    icons.municipio8, // Icona per Municipio 8 (verde)
    `
    <div class="baloon">
        <h3>Biblioteca Arcipelago Auditorium</h3>
        <p style="font-size: 15px;">
            Via Benedetto Croce, 50
            <br>00142 Municipio ROMA VIII
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Arcipelago%20Auditorium/RMBM1">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    8, // Municipio
    map // Mappa
);

    createMarker(
    [41.856922, 12.486069], // Coordinate
    "Biblioteca Joyce Lussu", // Titolo
    icons.municipio8, // Icona per Municipio 8 (verde)
    `
    <div class="baloon">
        <h3>Biblioteca Joyce Lussu</h3>
        <p style="font-size: 15px;">
            Via Costantino, 49A
            <br>00145 Municipio ROMA VIII
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Joyce%20Lussu/RMBM2">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    8, // Municipio
    map // Mappa
);

    createMarker(
    [41.785285, 12.440257], // Coordinate
    "Biblioteca Pier Paolo Pasolini", // Titolo
    icons.municipio9, // Icona per Municipio 9 (blu)
    `
    <div class="baloon">
        <h3>Biblioteca Pier Paolo Pasolini</h3>
        <p style="font-size: 15px;">
            Viale Caduti per la Resistenza, 410/A
            <br>00128 Municipio ROMA IX
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Pier%20Paolo%20Pasolini/RMBN1">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    9, // Municipio
    map // Mappa
);

    createMarker(
    [41.812215, 12.469236], // Coordinate
    "Biblioteca Laurentina", // Titolo
    icons.municipio9, // Icona per Municipio 9 (blu)
    `
    <div class="baloon">
        <h3>Biblioteca Laurentina</h3>
        <p style="font-size: 15px;">
            Piazzale Elsa Morante
            <br>00143 Municipio ROMA IX
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Laurentina/RMBN2">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    9, // Municipio
    map // Mappa
);

    createMarker(
    [41.732522, 12.271879], // Coordinate
    "Biblioteca Elsa Morante", // Titolo
    icons.municipio10, // Icona per Municipio 10 (rosso)
    `
    <div class="baloon">
        <h3>Biblioteca Elsa Morante</h3>
        <p style="font-size: 15px;">
            Via Adolfo Cozza 7
            <br>00121 Municipio ROMA X
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Elsa%20Morante/RMBO2">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    10, // Municipio
    map // Mappa
);

    createMarker(
    [41.775700, 12.348255], // Coordinate
    "Biblioteca Sandro Onofri", // Titolo
    icons.municipio10, // Icona per Municipio 10 (rosso)
    `
    <div class="baloon">
        <h3>Biblioteca Sandro Onofri</h3>
        <p style="font-size: 15px;">
            Via Umberto Lilloni, 39/45
            <br>00125 Municipio ROMA X
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Sandro%20Onofri/RMBO1">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    10, // Municipio
    map // Mappa
);

    createMarker(
    [41.8501037, 12.4140277], // Coordinate
    "Biblioteca Renato Nicolini", // Titolo
    icons.municipio11, // Icona per Municipio 11 (giallo)
    `
    <div class="baloon">
        <h3>Biblioteca Renato Nicolini</h3>
        <p style="font-size: 15px;">
            Via M. Mazzacurati, 76
            <br>00148 Municipio ROMA XI
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Renato%20Nicolini/RMBQ2">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    11, // Municipio
    map // Mappa
);

    createMarker(
    [41.862264, 12.465228], // Coordinate
    "Biblioteca Guglielmo Marconi", // Titolo
    icons.municipio11, // Icona per Municipio 11 (giallo)
    `
    <div class="baloon">
        <h3>Biblioteca Guglielmo Marconi</h3>
        <p style="font-size: 15px;">
            Via Gerolamo Cardano, 135
            <br>00146 Municipio ROMA XI
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Guglielmo%20Marconi/RMBQ1">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    11, // Municipio
    map // Mappa
);

    createMarker(
    [41.867787, 12.444878], // Coordinate
    "Biblioteca Colli Portuensi", // Titolo
    icons.municipio12, // Icona per Municipio 12 (viola)
    `
    <div class="baloon">
        <h3>Biblioteca Colli Portuensi</h3>
        <p style="font-size: 15px;">
            Viale dei Colli Portuensi, 275
            <br>00151 Municipio ROMA XII
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Colli%20Portuensi/RMBR1">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    12, // Municipio
    map // Mappa
);

    
createMarker(
    [41.86939, 12.41024], // Coordinate
    "Biblioteca Longhena", // Titolo
    icons.municipio12, // Icona per Municipio 12 (viola)
    `
    <div class="baloon">
        <h3>Biblioteca Longhena</h3>
        <p style="font-size: 15px;">
            Via B. Longhena, 98
            <br>00163 Municipio ROMA XII
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Longhena/RMBR2">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    12, // Municipio
    map // Mappa
);

    createMarker(
    [41.888458, 12.455285], // Coordinate
    "Biblioteca Villino Corsini - Villa Pamphilj", // Titolo
    icons.municipio12, // Icona per Municipio 12 (viola)
    `
    <div class="baloon">
        <h3>Biblioteca Villino Corsini - Villa Pamphilj</h3>
        <p style="font-size: 15px;">
            Largo 3 giugno 1849, snc
            <br>00164 Municipio ROMA XII
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Villino%20Corsini%20-%20Villa%20Pamphilj/RMBR3">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    12, // Municipio
    map // Mappa
);

createMarker(
    [41.907000, 12.393447], // Coordinate
    "Biblioteca Cornelia", // Titolo
    icons.municipio13, // Icona per Municipio 13 (arancione)
    `
    <div class="baloon">
        <h3>Biblioteca Cornelia</h3>
        <p style="font-size: 15px;">
            Via Gaetano Mazzoni, 85 (presso Sala polifunzionale Ex Campari)
            <br>00166 Municipio ROMA XIII
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Cornelia/RMBT2">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    13, // Municipio
    map // Mappa
);

createMarker(
    [41.904970, 12.437202], // Coordinate
    "Biblioteca Valle Aurelia", // Titolo
    icons.municipio13, // Icona per Municipio 13 (arancione)
    `
    <div class="baloon">
        <h3>Biblioteca Valle Aurelia</h3>
        <p style="font-size: 15px;">
            Viale di Valle Aurelia, 129
            <br>00167 Municipio ROMA XIII
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Valle%20Aurelia/RMBT1">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    13, // Municipio
    map // Mappa
);

    createMarker(
    [41.9181766, 12.4144799], // Coordinate
    "Biblioteca Franco Basaglia", // Titolo
    icons.municipio14, // Icona per Municipio 14 (grigio)
    `
    <div class="baloon">
        <h3>Biblioteca Franco Basaglia</h3>
        <p style="font-size: 15px;">
            Via Federico Borromeo, 67
            <br>00168 Municipio ROMA XIV
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Franco%20Basaglia/RMBU1">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    14, // Municipio
    map // Mappa
);

   createMarker(
    [41.9104619, 12.4251951], // Coordinate
    "Biblioteca Casa del Parco", // Titolo
    icons.municipio14, // Icona per Municipio 14 (grigio)
    `
    <div class="baloon">
        <h3>Biblioteca Casa del Parco</h3>
        <p style="font-size: 15px;">
            Via della Pineta Sacchetti, 78
            <br>00167 Municipio ROMA XIV
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Casa%20del%20Parco/RMBU2">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    14, // Municipio
    map // Mappa
);

    
    createMarker(
    [41.995762, 12.485857], // Coordinate
    "Biblioteca Galline Bianche", // Titolo
    icons.municipio15, // Icona per Municipio 15 (nero)
    `
    <div class="baloon">
        <h3>Biblioteca Galline Bianche</h3>
        <p style="font-size: 15px;">
            Via delle Galline Bianche, 105
            <br>00188 Municipio ROMA XV
        </p>
        <a style="color: #bc0b34; font-size: 16px;" 
           href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Galline%20Bianche/RMBV1">
           Vai alla scheda
        </a>
    </div>
    `, // Popup content
    15, // Municipio
    map // Mappa
);
           
    


    
  
            
let routingControl = null;
let municipioLayer = null;


   async function showMunicipioI() {
  // Rimuovi il layer precedente se esiste
  if (municipioLayer) {
    map.removeLayer(municipioLayer);
  }
  
  try {
    const response = await fetch('municipio1.geojson');
    const data = await response.json();
    
    municipioLayer = L.geoJSON(data, {
      style: {
        color: '#6a3f3a',
        weight: 3,
        opacity: 0.65,
        fillOpacity: 0.2
      }
    }).addTo(map);
    
    map.fitBounds(municipioLayer.getBounds());
  } catch (error) {
    console.error('Errore nel caricamento del confine:', error);
  }
}
            
            window.searchRoute = async function() {
                const startPoint = document.getElementById('start-point').value;
                
                if (routingControl) {
                    map.removeControl(routingControl);
                }

                try {
                    const response = await axios.get('https://nominatim.openstreetmap.org/search', {
                        params: {
                            q: startPoint,
                            format: 'json',
                            limit: 1
                        }
                    });

                    if (response.data.length > 0) {
                        const startCoords = [
                            parseFloat(response.data[0].lat), 
                            parseFloat(response.data[0].lon)
                        ];

                        routingControl = L.Routing.control({
                            waypoints: [
                                L.latLng(startCoords[0], startCoords[1]),
                                L.latLng(center[0], center[1])
                            ],
                            routeWhileDragging: true,
                            language: 'it',
                            show: true,
                            addWaypoints: false,
                            draggableWaypoints: false,
                            fitSelectedRoutes: true,
                            lineOptions: {
                                styles: [{color: '#0000FF', opacity: 0.8, weight: 5}]
                            },
                            createMarker: function(i, waypoint, n) {
                                const closeBtn = document.createElement('button');
                                closeBtn.innerHTML = '✕';
                                closeBtn.className = 'routing-close-btn';
                                closeBtn.onclick = function() {
                                    map.removeControl(routingControl);
                                };

                                // Append close button to routing container
                                setTimeout(() => {
                                    const container = document.querySelector('.leaflet-routing-container');
                                    if (container) {
                                        container.appendChild(closeBtn);
                                    }
                                }, 100);

                                return null; // No markers for waypoints
                            }
                        }).addTo(map);
                    } else {
                        alert('Indirizzo non trovato. Riprova.');
                    }
                } catch (error) {
                    console.error('Errore nella ricerca del percorso:', error);
                    alert('Errore nel trovare il percorso. Riprova.');
                }
            }

            document.getElementById('start-point').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    searchRoute();
                }
            });

            document.getElementById('start-point').focus();



// Fetch and display the municipality border
fetch('municipio10.geojson')
    .then(response => response.json())
    .then(data => {
        const municipalityColors = {
            1: "#6a3f3a", 2: "#00faff", 3: "#fbd51c", 4: "#473e86",
            5: "#018a87", 6: "#d33682", 7: "#ff7c4e", 8: "#22a825",
            9: "#2b83cb", 10: "#cb283c", 11: "#cac12e", 12: "#a329ca",
            13: "#c9832c", 14: "#7b7b79", 15: "#000000"
        };

        // Variabili globali per gestire i layer
        let municipioLayers = {};
        let currentHighlight = null;
        let currentBorder = null;
        let selectedMunicipio = null;

        // Carica il municipio X di default
        municipioLayers[10] = L.geoJSON(data, {
            style: {
                color: municipalityColors[10],
                weight: 3,
                opacity: 0.65,
                fillOpacity: 0
            }
        }).addTo(map);

        // Aggiungi la legenda interattiva
         const legend = L.control({ position: 'bottomright' });
   // Replace the legend.onAdd function with this corrected version
legend.onAdd = function() {
    const div = L.DomUtil.create("div", "legend");
    
    // Define municipality colors (moved from earlier in the code)
    const municipalityColors = {
        1: "#6a3f3a",
        2: "#00faff", 
        3: "#fbd51c",
        4: "#473e86",
        5: "#018a87",
        6: "#d33682",
        7: "#ff7c4e",
        8: "#22a825",
        9: "#2b83cb",
        10: "#cb283c",
        11: "#cac12e",
        12: "#a329ca",
        13: "#c9832c",
        14: "#7b7b79",
        15: "#000000"
    };

    div.innerHTML = `
        <h4>Mappa Biblioteche di Roma per Municipi</h4>
        <div class="legend-grid">
            ${Object.entries(municipalityColors).map(([num, color]) => `
                <div class="legend-item ${num === '10' ? 'disabled' : ''}" 
                     data-municipio="${num}" 
                     ${num !== '10' ? `onmouseover="handleLegendHover(${num})" 
                     onmouseout="handleLegendOut(${num})" 
                     onclick="handleLegendClick(${num})"` : ''}>
                    <span style="background: ${color}"></span>
                    <div class="text">Municipio ${romanize(parseInt(num))}</div>
                </div>
            `).join("")}
        </div>
    `;
    
    return div;
};
    legend.addTo(map);

        // Funzione per convertire numeri in numeri romani
        function romanize(num) {
            const roman = ['I','II','III','IV','V','VI','VII','VIII','IX','X','XI','XII','XIII','XIV','XV'];
            return roman[num - 1] || num;
        }

        // Gestore hover sulla legenda
// Funzione per gestire l'hover sulla legenda
window.handleLegendHover = async function(municipioNumber) {
                // Non mostrare l'hover se il municipio è già selezionato
                if (municipioNumber === selectedMunicipio) return;

                const item = document.querySelector(`.legend-item[data-municipio="${municipioNumber}"]`);
                item.classList.add('highlighted');

                if (!municipioLayers[municipioNumber]) {
                    try {
                        const response = await fetch(`municipio${municipioNumber}.geojson`);
                        const data = await response.json();
                        municipioLayers[municipioNumber] = L.geoJSON(data, {
                            style: {
                                color: municipalityColors[municipioNumber],
                                weight: 4,
                                opacity: 0.9,
                                fillOpacity: 0.1
                            }
                        });
                    } catch (error) {
                        console.error(`Error loading municipality ${municipioNumber}:`, error);
                        return;
                    }
                }

                if (currentHighlight && currentHighlight !== currentBorder) {
                    map.removeLayer(currentHighlight);
                }
                
                currentHighlight = municipioLayers[municipioNumber].addTo(map).bringToFront();
            };

            // Funzione per gestire l'uscita del mouse dalla legenda
            window.handleLegendOut = function(municipioNumber) {
                if (municipioNumber === selectedMunicipio) return;

                const item = document.querySelector(`.legend-item[data-municipio="${municipioNumber}"]`);
                item.classList.remove('highlighted');

                if (currentHighlight && currentHighlight !== currentBorder) {
                    map.removeLayer(currentHighlight);
                    currentHighlight = null;
                }

                // Se c'è un municipio selezionato, assicurati che rimanga visibile
                if (selectedMunicipio && currentBorder) {
                    currentBorder.bringToFront();
                }
            };

            // Funzione per gestire il click sulla legenda
            window.handleLegendClick = async function(municipioNumber) {
                const allItems = document.querySelectorAll('.legend-item');
                allItems.forEach(item => item.classList.remove('highlighted'));

                // Se clicchiamo sullo stesso municipio, lo deselezioniamo
                if (selectedMunicipio === municipioNumber) {
                    if (currentBorder) {
                        map.removeLayer(currentBorder);
                        currentBorder = null;
                    }
                    selectedMunicipio = null;
                    return;
                }

                // Carica il nuovo municipio se non è già stato caricato
                if (!municipioLayers[municipioNumber]) {
                    try {
                        const response = await fetch(`municipio${municipioNumber}.geojson`);
                        const data = await response.json();
                        municipioLayers[municipioNumber] = L.geoJSON(data, {
                            style: {
                                color: municipalityColors[municipioNumber],
                                weight: 4,
                                opacity: 0.9,
                                fillOpacity: 0.2
                            }
                        });
                    } catch (error) {
                        console.error(`Error loading municipality ${municipioNumber}:`, error);
                        return;
                    }
                }

                // Rimuovi il bordo precedente se esiste
                if (currentBorder) {
                    map.removeLayer(currentBorder);
                }

                // Imposta il nuovo municipio selezionato
                selectedMunicipio = municipioNumber;
                const item = document.querySelector(`.legend-item[data-municipio="${municipioNumber}"]`);
                item.classList.add('highlighted');

                // Aggiungi il nuovo bordo
                currentBorder = municipioLayers[municipioNumber].addTo(map).bringToFront();
                map.fitBounds(currentBorder.getBounds());
            };
        })
        .catch(error => console.error('Errore nel caricamento dei confini:', error));
});
    </script>
</body>
</html>
