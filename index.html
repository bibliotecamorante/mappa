<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Municipio X - Biblioteca Elsa Morante</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="icon" href="favicon.png" type="image/png">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .search-box {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
        }
        .search-box input {
            width: 250px;
            margin-right: 10px;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 14px;
        }
        .search-box button {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        .search-box .icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            cursor: pointer;
        }
        .search-box .separator {
            width: 1px;
            height: 24px;
            background-color: #ccc;
            margin: 0 10px;
        }
        .legend {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
        }
        .legend-item {
            display: flex;
            align-items: center;
        }
        .legend-item span {
            width: 16px;
            height: 16px;
            margin-right: 4px;
            background-color: #970a2c;
        }
        .routing-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            background-color: rgba(255, 77, 77, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            z-index: 1000;
            transition: background-color 0.3s;
        }
        .routing-close-btn:hover {
            background-color: rgba(255, 26, 26, 0.8);
        }
        .custom-popup .leaflet-popup-content-wrapper {
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
        }
        .custom-popup .leaflet-popup-tip {
            background-color: rgba(255, 255, 255, 0.7);
        }
        .custom-popup {
            margin-bottom: 30px;
        }
        .custom-popup .leaflet-popup-close-button {
            color: #ff4d4d;
            font-size: 20px;
            font-weight: bold;
            opacity: 1;
            right: 8px;
            top: 8px;
        }
        .custom-popup .leaflet-popup-close-button:hover {
            color: #ff1a1a;
        }
    </style>
</head>
<body>
    <div class="search-box">
        <a href="#" onclick="handleBackNavigation(); return false;" title="Torna indietro">
            <img src="left.svg" alt="Pagina precedente" class="icon">
        </a>
        <div class="separator"></div>
        <a href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Elsa%20Morante/RMBO2" title="Vai alla Biblioteca Morante">
            <img src="home.svg" alt="Biblioteca Home" class="icon">
        </a>
        <input type="text" id="start-point" placeholder="Inserisci punto di partenza">
        <button onclick="searchRoute()" title="Trova percorso fino alla Biblioteca Morante">Trova Percorso</button>
    </div>
    <div id="map"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    
    <script>
        function handleBackNavigation() {
            const previousPage = localStorage.getItem('previousPage');
            switch (true) {
                case previousPage === 'donazione':
                    window.location.href = 'https://bibliotecamorante.github.io/donazione/';
                    break;
                case previousPage === 'termini':
                    window.location.href = 'https://bibliotecamorante.github.io/donazione/termini.html';
                    break;
                default:
                    window.history.back();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (document.referrer.includes('bibliotecamorante.github.io/donazione/')) {
                if (document.referrer.includes('termini.html')) {
                    localStorage.setItem('previousPage', 'termini');
                } else {
                    localStorage.setItem('previousPage', 'donazione');
                }
            }

            const biblioCoords = [41.732522, 12.271879];
            
            const map = L.map('map').setView(biblioCoords, 14);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Percorso pedonale alla biblioteca
            const percorso = [
                biblioCoords,
                [41.732154, 12.271675],
                [41.732282, 12.271254],
                [41.732240, 12.271230],
                [41.732276, 12.271090],
                [41.732092, 12.270980],
            ];

            const dashedPath = L.polyline(percorso, {
                color: '#0000FF',
                weight: 4,
                opacity: 0.8,
                dashArray: '10, 10'
            }).addTo(map);

            // Marker della biblioteca
            const markerCoords = percorso[percorso.length - 1];
            const marker = L.marker(markerCoords).addTo(map);
            
            const popup = L.popup({
                className: 'custom-popup',
                offset: [0, -10],
                closeButton: true
            })
                .setLatLng(markerCoords)
                .setContent(`
                    <b>Biblioteca Elsa Morante</b><br>
                    Via Adolfo Cozza, 7<br>
                    <small>Lun-Ven 09:00-18:30 • Sab 09:00-13:00</small>
                `)
                .openOn(map);

            // Confini del Municipio X
            const municipioBoundaries = [
    [
        [41.7325, 12.2718],
        [41.7326, 12.2719],
        [41.7327, 12.2720],
        [41.7328, 12.2721],
        [41.7330, 12.2724],
        [41.7331, 12.2726],
        [41.7333, 12.2728],
        [41.7335, 12.2730],
        [41.7336, 12.2731],
        [41.7338, 12.2733],
        [41.7340, 12.2735],
        [41.7342, 12.2737],
        [41.7344, 12.2740],
        [41.7346, 12.2742],
        [41.7348, 12.2745],
        [41.7350, 12.2747],
        [41.7352, 12.2750],
        [41.7354, 12.2752],
        [41.7356, 12.2755],
        [41.7358, 12.2757],
        [41.7360, 12.2760],
        [41.7362, 12.2762],
        [41.7364, 12.2765],
        [41.7366, 12.2767],
        [41.7368, 12.2770],
        [41.7370, 12.2772],
        [41.7372, 12.2775],
        [41.7374, 12.2777],
        [41.7376, 12.2780],
        [41.7378, 12.2782],
        [41.7380, 12.2785],
        [41.7382, 12.2787],
        [41.7384, 12.2790],
        [41.7386, 12.2792],
        [41.7388, 12.2795],
        [41.7390, 12.2797],
        [41.7392, 12.2800],
        [41.7394, 12.2802],
        [41.7396, 12.2805],
        [41.7398, 12.2807],
        [41.7400, 12.2810],
        [41.7402, 12.2812],
        [41.7404, 12.2815],
        [41.7406, 12.2817],
        [41.7408, 12.2820],
        [41.7410, 12.2822],
        [41.7412, 12.2825],
        [41.7414, 12.2827],
        [41.7416, 12.2830],
        [41.7418, 12.2832],
        [41.7420, 12.2835],
        [41.7422, 12.2837],
        [41.7424, 12.2840],
        [41.7426, 12.2842],
        [41.7428, 12.2845],
        [41.7430, 12.2847],
        [41.7432, 12.2850],
        [41.7434, 12.2852],
        [41.7436, 12.2855],
        [41.7438, 12.2857],
        [41.7440, 12.2860]
    ],
    [
        [41.7440, 12.2860],
        [41.7442, 12.2862],
        [41.7444, 12.2865],
        [41.7446, 12.2867],
        [41.7448, 12.2870],
        [41.7450, 12.2872],
        [41.7452, 12.2875],
        [41.7454, 12.2877],
        [41.7456, 12.2880],
        [41.7458, 12.2882],
        [41.7460, 12.2885],
        [41.7462, 12.2887],
        [41.7464, 12.2890],
        [41.7466, 12.2892],
        [41.7468, 12.2895],
        [41.7470, 12.2897],
        [41.7472, 12.2900],
        [41.7474, 12.2902],
        [41.7476, 12.2905],
        [41.7478, 12.2907],
        [41.7480, 12.2910],
        [41.7482, 12.2912],
        [41.7484, 12.2915],
        [41.7486, 12.2917],
        [41.7488, 12.2920],
        [41.7490, 12.2922],
        [41.7492, 12.2925],
        [41.7494, 12.2927],
        [41.7496, 12.2930],
        [41.7498, 12.2932],
        [41.7500, 12.2935]
    ],
    [
        [41.7500, 12.2935],
        [41.7498, 12.2937],
        [41.7496, 12.2940],
        [41.7494, 12.2942],
        [41.7492, 12.2945],
        [41.7490, 12.2947],
        [41.7488, 12.2950],
        [41.7486, 12.2952],
        [41.7484, 12.2955],
        [41.7482, 12.2957],
        [41.7480, 12.2960],
        [41.7478, 12.2962],
        [41.7476, 12.2965],
        [41.7474, 12.2967],
        [41.7472, 12.2970],
        [41.7470, 12.2972],
        [41.7468, 12.2975],
        [41.7466, 12.2977],
        [41.7464, 12.2980],
        [41.7462, 12.2982],
        [41.7460, 12.2985],
        [41.7458, 12.2987],
        [41.7456, 12.2990],
        [41.7454, 12.2992],
        [41.7452, 12.2995],
        [41.7450, 12.2997],
        [41.7448, 12.3000],
        [41.7446, 12.3002],
        [41.7444, 12.3005],
        [41.7442, 12.3007],
        [41.7440, 12.3010]
    ]
];

            // Disegna i confini
            municipioBoundaries.forEach(boundary => {
                L.polyline(boundary, {
                    color: '#970a2c',
                    weight: 3,
                    opacity: 0.7
                }).addTo(map);
            });

            // Aggiungi la legenda
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function() {
                this._div = L.DomUtil.create('div', 'legend');
                this._div.innerHTML = '<div class="legend-item"><span></span>Municipio X</div>';
                return this._div;
            };
            legend.addTo(map);

            let routingControl = null;
            
            window.searchRoute = async function() {
                const startPoint = document.getElementById('start-point').value;
                
                if (routingControl) {
                    map.removeControl(routingControl);
                }

                try {
                    const response = await axios.get('https://nominatim.openstreetmap.org/search', {
                        params: {
                            q: startPoint,
                            format: 'json',
                            limit: 1
                        }
                    });

                    if (response.data.length > 0) {
                        const startCoords = [
                            parseFloat(response.data[0].lat), 
                            parseFloat(response.data[0].lon)
                        ];

                        routingControl = L.Routing.control({
                            waypoints: [
                                L.latLng(startCoords[0], startCoords[1]),
                                L.latLng(biblioCoords[0], biblioCoords[1])
                            ],
                            routeWhileDragging: true,
                            language: 'it',
                            show: true,
                            addWaypoints: false,
                            draggableWaypoints: false,
                            fitSelectedRoutes: true,
                            lineOptions: {
                                styles: [{color: '#0000FF', opacity: 0.8, weight: 5}]
                            },
                            createMarker: function(i, waypoint, n) {
                                const closeBtn = document.createElement('button');
                                closeBtn.innerHTML = '✕';
                                closeBtn.className = 'routing-close-btn';
                                closeBtn.onclick = function() {
                                    map.removeControl(routingControl);
                                };

                                setTimeout(() => {
                                    const container = document.querySelector('.leaflet-routing-container');
                                    if (container) {
                                        container.appendChild(closeBtn);
                                    }
                                }, 100);

                                return null;
                            }
                        }).addTo(map);
                    } else {
                        alert('Indirizzo non trovato. Riprova.');
                    }
                } catch (error) {
                    console.error('Errore nella ricerca del percorso:', error);
                    alert('Errore nel trovare il percorso. Riprova.');
                }
            };

            document.getElementById('start-point').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    searchRoute();
                }
            });

            document.getElementById('start-point').focus();
        });
    </script>
</body>
</html>
