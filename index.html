<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Municipio X - Biblioteca Elsa Morante</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="icon" href="favicon.png" type="image/png">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .search-box {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
        }
        .search-box input {
            width: 250px;
            margin-right: 10px;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 14px;
        }
        .search-box button {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        .search-box .icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            cursor: pointer;
        }
        .search-box .separator {
            width: 1px;
            height: 24px;
            background-color: #ccc;
            margin: 0 10px;
        }
        .legend {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
        }
        .legend-item {
            display: flex;
            align-items: center;
        }
        .legend-item span {
            width: 16px;
            height: 16px;
            margin-right: 4px;
            background-color: #970a2c;
        }
        .routing-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            background-color: rgba(255, 77, 77, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            z-index: 1000;
            transition: background-color 0.3s;
        }
        .routing-close-btn:hover {
            background-color: rgba(255, 26, 26, 0.8);
        }
        .custom-popup .leaflet-popup-content-wrapper {
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
        }
        .custom-popup .leaflet-popup-tip {
            background-color: rgba(255, 255, 255, 0.7);
        }
        .custom-popup {
            margin-bottom: 30px;
        }
        .custom-popup .leaflet-popup-close-button {
            color: #ff4d4d;
            font-size: 20px;
            font-weight: bold;
            opacity: 1;
            right: 8px;
            top: 8px;
        }
        .custom-popup .leaflet-popup-close-button:hover {
            color: #ff1a1a;
        }
    </style>
</head>
<body>
    <div class="search-box">
        <a href="#" onclick="handleBackNavigation(); return false;" title="Torna indietro">
            <img src="left.svg" alt="Pagina precedente" class="icon">
        </a>
        <div class="separator"></div>
        <a href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Elsa%20Morante/RMBO2" title="Vai alla Biblioteca Morante">
            <img src="home.svg" alt="Biblioteca Home" class="icon">
        </a>
        <input type="text" id="start-point" placeholder="Inserisci punto di partenza">
        <button onclick="searchRoute()" title="Trova percorso fino alla Biblioteca Morante">Trova Percorso</button>
    </div>
    <div id="map"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    
    <script>
        function handleBackNavigation() {
            const previousPage = localStorage.getItem('previousPage');
            switch (true) {
                case previousPage === 'donazione':
                    window.location.href = 'https://bibliotecamorante.github.io/donazione/';
                    break;
                case previousPage === 'termini':
                    window.location.href = 'https://bibliotecamorante.github.io/donazione/termini.html';
                    break;
                default:
                    window.history.back();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (document.referrer.includes('bibliotecamorante.github.io/donazione/')) {
                if (document.referrer.includes('termini.html')) {
                    localStorage.setItem('previousPage', 'termini');
                } else {
                    localStorage.setItem('previousPage', 'donazione');
                }
            }

            const biblioCoords = [41.732522, 12.271879];
            
            const map = L.map('map').setView(biblioCoords, 14);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Percorso pedonale alla biblioteca
            const percorso = [
                biblioCoords,
                [41.732154, 12.271675],
                [41.732282, 12.271254],
                [41.732240, 12.271230],
                [41.732276, 12.271090],
                [41.732092, 12.270980],
            ];

            const dashedPath = L.polyline(percorso, {
                color: '#0000FF',
                weight: 4,
                opacity: 0.8,
                dashArray: '10, 10'
            }).addTo(map);

            // Marker della biblioteca
            const markerCoords = percorso[percorso.length - 1];
            const marker = L.marker(markerCoords).addTo(map);
            
            const popup = L.popup({
                className: 'custom-popup',
                offset: [0, -10],
                closeButton: true
            })
                .setLatLng(markerCoords)
                .setContent(`
                    <b>Biblioteca Elsa Morante</b><br>
                    Via Adolfo Cozza, 7<br>
                    <small>Lun-Ven 09:00-18:30 • Sab 09:00-13:00</small>
                `)
                .openOn(map);

            // Confini del Municipio X
// Coordinate precise del perimetro del Municipio X
const municipioBoundaries = [
    [41.7424, 12.2308],
    [41.7425, 12.2317],
    [41.7439, 12.2326],
    [41.7453, 12.2335],
    [41.7467, 12.2344],
    [41.7481, 12.2353],
    [41.7495, 12.2362],
    [41.7509, 12.2371],
    [41.7523, 12.2380],
    [41.7537, 12.2389],
    [41.7551, 12.2398],
    [41.7565, 12.2407],
    [41.7579, 12.2416],
    [41.7593, 12.2425],
    [41.7607, 12.2434],
    [41.7621, 12.2443],
    [41.7635, 12.2452],
    [41.7649, 12.2461],
    [41.7663, 12.2470],
    [41.7677, 12.2479],
    [41.7691, 12.2488],
    [41.7705, 12.2497],
    [41.7719, 12.2506],
    [41.7733, 12.2515],
    [41.7747, 12.2524],
    [41.7761, 12.2533],
    [41.7775, 12.2542],
    [41.7789, 12.2551],
    [41.7803, 12.2560],
    [41.7817, 12.2569],
    [41.7831, 12.2578],
    [41.7845, 12.2587],
    [41.7859, 12.2596],
    [41.7873, 12.2605],
    [41.7887, 12.2614],
    [41.7901, 12.2623],
    [41.7915, 12.2632],
    [41.7929, 12.2641],
    [41.7943, 12.2650],
    [41.7957, 12.2659],
    [41.7971, 12.2668],
    [41.7985, 12.2677],
    [41.7999, 12.2686],
    [41.8013, 12.2695],
    [41.8027, 12.2704],
    [41.8041, 12.2713],
    [41.8055, 12.2722],
    [41.8069, 12.2731],
    [41.8083, 12.2740],
    [41.8097, 12.2749],
    // Sud-Est
    [41.8083, 12.2758],
    [41.8069, 12.2767],
    [41.8055, 12.2776],
    [41.8041, 12.2785],
    [41.8027, 12.2794],
    [41.8013, 12.2803],
    [41.7999, 12.2812],
    [41.7985, 12.2821],
    [41.7971, 12.2830],
    [41.7957, 12.2839],
    [41.7943, 12.2848],
    [41.7929, 12.2857],
    [41.7915, 12.2866],
    [41.7901, 12.2875],
    [41.7887, 12.2884],
    [41.7873, 12.2893],
    [41.7859, 12.2902],
    [41.7845, 12.2911],
    [41.7831, 12.2920],
    [41.7817, 12.2929],
    [41.7803, 12.2938],
    [41.7789, 12.2947],
    [41.7775, 12.2956],
    [41.7761, 12.2965],
    [41.7747, 12.2974],
    [41.7733, 12.2983],
    [41.7719, 12.2992],
    [41.7705, 12.3001],
    [41.7691, 12.3010],
    [41.7677, 12.3019],
    [41.7663, 12.3028],
    [41.7649, 12.3037],
    [41.7635, 12.3046],
    [41.7621, 12.3055],
    [41.7607, 12.3064],
    [41.7593, 12.3073],
    [41.7579, 12.3082],
    [41.7565, 12.3091],
    [41.7551, 12.3100],
    [41.7537, 12.3109],
    [41.7523, 12.3118],
    [41.7509, 12.3127],
    [41.7495, 12.3136],
    [41.7481, 12.3145],
    [41.7467, 12.3154],
    [41.7453, 12.3163],
    [41.7439, 12.3172],
    [41.7425, 12.3181],
    // Sud-Ovest
    [41.7411, 12.3172],
    [41.7397, 12.3163],
    [41.7383, 12.3154],
    [41.7369, 12.3145],
    [41.7355, 12.3136],
    [41.7341, 12.3127],
    [41.7327, 12.3118],
    [41.7313, 12.3109],
    [41.7299, 12.3100],
    [41.7285, 12.3091],
    [41.7271, 12.3082],
    [41.7257, 12.3073],
    [41.7243, 12.3064],
    [41.7229, 12.3055],
    [41.7215, 12.3046],
    [41.7201, 12.3037],
    [41.7187, 12.3028],
    [41.7173, 12.3019],
    [41.7159, 12.3010],
    [41.7145, 12.3001],
    [41.7131, 12.2992],
    [41.7117, 12.2983],
    [41.7103, 12.2974],
    [41.7089, 12.2965],
    [41.7075, 12.2956],
    [41.7061, 12.2947],
    [41.7047, 12.2938],
    [41.7033, 12.2929],
    [41.7019, 12.2920],
    [41.7005, 12.2911],
    [41.6991, 12.2902],
    [41.6977, 12.2893],
    [41.6963, 12.2884],
    [41.6949, 12.2875],
    [41.6935, 12.2866],
    [41.6921, 12.2857],
    [41.6907, 12.2848],
    [41.6893, 12.2839],
    [41.6879, 12.2830],
    [41.6865, 12.2821],
    [41.6851, 12.2812],
    // Nord-Ovest
    [41.6865, 12.2803],
    [41.6879, 12.2794],
    [41.6893, 12.2785],
    [41.6907, 12.2776],
    [41.6921, 12.2767],
    [41.6935, 12.2758],
    [41.6949, 12.2749],
    [41.6963, 12.2740],
    [41.6977, 12.2731],
    [41.6991, 12.2722],
    [41.7005, 12.2713],
    [41.7019, 12.2704],
    [41.7033, 12.2695],
    [41.7047, 12.2686],
    [41.7061, 12.2677],
    [41.7075, 12.2668],
    [41.7089, 12.2659],
    [41.7103, 12.2650],
    [41.7117, 12.2641],
    [41.7131, 12.2632],
    [41.7145, 12.2623],
    [41.7159, 12.2614],
    [41.7173, 12.2605],
    [41.7187, 12.2596],
    [41.7201, 12.2587],
    [41.7215, 12.2578],
    [41.7229, 12.2569],
    [41.7243, 12.2560],
    [41.7257, 12.2551],
    [41.7271, 12.2542],
    [41.7285, 12.2533],
    [41.7299, 12.2524],
    [41.7313, 12.2515],
    [41.7327, 12.2506],
    [41.7341, 12.2497],
    [41.7355, 12.2488],
    [41.7369, 12.2479],
    [41.7383, 12.2470],
    [41.7397, 12.2461],
    [41.7411, 12.2452],
    // Chiusura del poligono
    [41.7424, 12.2308]  // Stesso punto iniziale per chiudere il poligono
];

// Utilizzo:
const municipioPolygon = L.polygon(municipioBoundaries, {
    color: '#970a2c',
    weight: 3,
    opacity: 0.7,
    fillColor: '#970a2c',
    fillOpacity: 0.1
}).addTo(map);

// Centra la mappa sui confini del municipio
map.fitBounds(municipioPolygon.getBounds());

            // Aggiungi la legenda
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function() {
                this._div = L.DomUtil.create('div', 'legend');
                this._div.innerHTML = '<div class="legend-item"><span></span>Municipio X</div>';
                return this._div;
            };
            legend.addTo(map);

            let routingControl = null;
            
            window.searchRoute = async function() {
                const startPoint = document.getElementById('start-point').value;
                
                if (routingControl) {
                    map.removeControl(routingControl);
                }

                try {
                    const response = await axios.get('https://nominatim.openstreetmap.org/search', {
                        params: {
                            q: startPoint,
                            format: 'json',
                            limit: 1
                        }
                    });

                    if (response.data.length > 0) {
                        const startCoords = [
                            parseFloat(response.data[0].lat), 
                            parseFloat(response.data[0].lon)
                        ];

                        routingControl = L.Routing.control({
                            waypoints: [
                                L.latLng(startCoords[0], startCoords[1]),
                                L.latLng(biblioCoords[0], biblioCoords[1])
                            ],
                            routeWhileDragging: true,
                            language: 'it',
                            show: true,
                            addWaypoints: false,
                            draggableWaypoints: false,
                            fitSelectedRoutes: true,
                            lineOptions: {
                                styles: [{color: '#0000FF', opacity: 0.8, weight: 5}]
                            },
                            createMarker: function(i, waypoint, n) {
                                const closeBtn = document.createElement('button');
                                closeBtn.innerHTML = '✕';
                                closeBtn.className = 'routing-close-btn';
                                closeBtn.onclick = function() {
                                    map.removeControl(routingControl);
                                };

                                setTimeout(() => {
                                    const container = document.querySelector('.leaflet-routing-container');
                                    if (container) {
                                        container.appendChild(closeBtn);
                                    }
                                }, 100);

                                return null;
                            }
                        }).addTo(map);
                    } else {
                        alert('Indirizzo non trovato. Riprova.');
                    }
                } catch (error) {
                    console.error('Errore nella ricerca del percorso:', error);
                    alert('Errore nel trovare il percorso. Riprova.');
                }
            };

            document.getElementById('start-point').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    searchRoute();
                }
            });

            document.getElementById('start-point').focus();
        });
    </script>
</body>
</html>
